{% extends 'layout.html' %}

{% block title %}Assets{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-md-12">
            <h1 class="display-5 mb-4">Assets</h1>
            
            <!-- Network Scan Button -->
            <div class="mb-4">
                <button type="button" class="btn btn-primary" id="scanButton">
                    <i class="fas fa-search me-2"></i>Network Scan
                </button>
            </div>
            
            <!-- 스캔 결과 알림 -->
            <div id="scanAlert" class="alert d-none mb-4"></div>
            
            <!-- Assets Table -->
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Asset List</h5>
                    <div>
                    <span class="badge bg-primary">{{ assets|length }} assets</span>
                        <div class="btn-group ms-2">
                            <button class="btn btn-sm btn-outline-light active" id="allAssets">All</button>
                            <button class="btn btn-sm btn-outline-light" id="hwAssets">HW</button>
                            <button class="btn btn-sm btn-outline-light" id="swAssets">SW</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>IP Address</th>
                                    <th>Status</th>
                                    <th>Last Scan</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="assetsTableBody">
                                {% for asset in assets %}
                                <tr data-type="{{ asset.category|default('hardware') }}">
                                    <td>{{ asset.name }}</td>
                                    <td>{{ asset.asset_type }}</td>
                                    <td>{{ asset.ip_address }}</td>
                                    <td>
                                        <span class="badge {% if asset.status == 'online' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ asset.status }}
                                        </span>
                                    </td>
                                    <td>{{ asset.last_scan.strftime('%Y-%m-%d %H:%M:%S') if asset.last_scan else 'Never' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info asset-details" data-asset-id="{{ asset.id }}" data-bs-toggle="modal" data-bs-target="#assetDetailsModal">
                                            <i class="fas fa-info-circle"></i> Details
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Network Scan Modal -->
<div class="modal fade" id="scanModal" tabindex="-1" aria-labelledby="scanModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="scanModalLabel">Network Scan Results</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 스캔 진행 상태 -->
                <div id="scanProgress" class="mb-4">
                    <div class="progress bg-dark">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-center mt-2" id="scanStatus">Initializing scan...</div>
                </div>
                
                <!-- 숨겨진 subnet 필드 -->
                <input type="hidden" id="subnet" value="192.168.1.0/24">
                
                <!-- 스캔 결과 테이블 -->
                <div id="scanResults" class="table-responsive d-none">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Hostname</th>
                                <th>Device Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="scanResultsBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Asset Details Modal -->
<div class="modal fade" id="assetDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="assetDetailsTitle">Asset Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="assetDetailsBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading asset details...</p>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="refreshAssetBtn">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const scanButton = document.getElementById('scanButton');
    const scanModal = new bootstrap.Modal(document.getElementById('scanModal'));
    const scanProgress = document.getElementById('scanProgress');
    const scanResults = document.getElementById('scanResults');
    const scanResultsBody = document.getElementById('scanResultsBody');
    const progressBar = document.querySelector('.progress-bar');
    const scanStatus = document.getElementById('scanStatus');
    const scanAlert = document.getElementById('scanAlert');
    
    // 자산 분류 필터링
    const allAssetsBtn = document.getElementById('allAssets');
    const hwAssetsBtn = document.getElementById('hwAssets');
    const swAssetsBtn = document.getElementById('swAssets');
    const assetRows = document.querySelectorAll('#assetsTableBody tr');
    
    allAssetsBtn.addEventListener('click', function() {
        this.classList.add('active');
        hwAssetsBtn.classList.remove('active');
        swAssetsBtn.classList.remove('active');
        
        assetRows.forEach(row => {
            row.style.display = '';
        });
    });
    
    hwAssetsBtn.addEventListener('click', function() {
        this.classList.add('active');
        allAssetsBtn.classList.remove('active');
        swAssetsBtn.classList.remove('active');
        
        assetRows.forEach(row => {
            if (row.dataset.type === 'hardware' || row.dataset.type === '') {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
    
    swAssetsBtn.addEventListener('click', function() {
        this.classList.add('active');
        allAssetsBtn.classList.remove('active');
        hwAssetsBtn.classList.remove('active');
        
        assetRows.forEach(row => {
            if (row.dataset.type === 'software') {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
    
    // Asset Details 모달
    const assetDetailsButtons = document.querySelectorAll('.asset-details');
    assetDetailsButtons.forEach(button => {
        button.addEventListener('click', function() {
            const assetId = this.dataset.assetId;
            loadAssetDetails(assetId);
        });
    });
    
    // Refresh Asset 버튼
    document.getElementById('refreshAssetBtn').addEventListener('click', function() {
        const assetId = this.dataset.assetId;
        if (assetId) {
            loadAssetDetails(assetId);
        }
    });
    
    // 자산 상세 정보 로드 함수
    function loadAssetDetails(assetId) {
        const detailsBody = document.getElementById('assetDetailsBody');
        const refreshBtn = document.getElementById('refreshAssetBtn');
        
        // 로딩 표시
        detailsBody.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading asset details...</p>
            </div>
        `;
        
        refreshBtn.dataset.assetId = assetId;
        
        // 실제 네트워크 장비 정보를 가져오기 위한 API 호출
        fetch(`/api/assets/${assetId}/details?use_enhanced_detection=true&deep_scan=true`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load asset details');
                }
                return response.json();
            })
            .then(data => {
                displayAssetDetails(data);
            })
            .catch(error => {
                console.error('Error loading asset details:', error);
                
                // 에러 발생 시 실시간 장비 스캔 시도
                detailsBody.innerHTML = `
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        기존 자산 정보를 가져오는 데 실패했습니다. 실시간 장비 스캔을 시도합니다...
                    </div>
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">네트워크 장비 실시간 스캔 중...</p>
                    </div>
                `;
                
                // 실시간 장비 스캔 API 호출
                setTimeout(() => {
                    scanSingleDevice(assetId)
                        .then(data => {
                            displayAssetDetails(data);
                        })
                        .catch(scanError => {
                            console.error('Error scanning device:', scanError);
                            detailsBody.innerHTML = `
                                <div class="alert alert-danger" role="alert">
                                    <i class="fas fa-times-circle me-2"></i>
                                    장비 스캔에 실패했습니다: ${scanError.message}
                                </div>
                                <div class="mt-3">
                                    <h5>장비 정보를 가져오는 데 실패한 이유:</h5>
                                    <ul>
                                        <li>장비에 대한 네트워크 연결이 불가능할 수 있습니다.</li>
                                        <li>SNMP 커뮤니티 문자열이 잘못되었을 수 있습니다.</li>
                                        <li>장비에서 SNMP, SSH 또는 기타 관리 프로토콜이 비활성화되었을 수 있습니다.</li>
                                        <li>방화벽이 필요한 포트를 차단하고 있을 수 있습니다.</li>
                                    </ul>
                                    <p>아래 버튼을 클릭하여 장비 스캔 설정을 구성하고 다시 시도하세요.</p>
                                    <button class="btn btn-primary" onclick="configureScanSettings(${assetId})">
                                        <i class="fas fa-cog me-2"></i> 스캔 설정 구성
                                    </button>
                                </div>
                            `;
                        });
                }, 1000);
            });
    }
    
    // 단일 장비 스캔 함수
    function scanSingleDevice(assetId) {
        return new Promise((resolve, reject) => {
            // 서버에 단일 장비 스캔 요청
            fetch(`/api/scan_device/${assetId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    scan_methods: ['snmp', 'ssh', 'http', 'wmi'],
                    timeout: 30,
                    snmp_community: 'public',
                    snmp_version: '2c',
                    ssh_enabled: true,
                    deep_fingerprinting: true
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Failed to scan device');
                    });
                }
                return response.json();
            })
            .then(data => {
                // 스캔 결과 확인
                if (data.success) {
                    resolve(data.device_info);
                } else {
                    reject(new Error(data.error || 'Unknown error during device scan'));
                }
            })
            .catch(error => {
                reject(error);
            });
        });
    }
    
    // 스캔 설정 구성 함수
    function configureScanSettings(assetId) {
        const detailsBody = document.getElementById('assetDetailsBody');
        
        detailsBody.innerHTML = `
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h5 class="mb-0">장비 스캔 설정</h5>
                </div>
                <div class="card-body">
                    <form id="scanSettingsForm">
                        <input type="hidden" name="asset_id" value="${assetId}">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">스캔 방법</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="snmpEnabled" name="snmp_enabled" checked>
                                    <label class="form-check-label" for="snmpEnabled">SNMP</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sshEnabled" name="ssh_enabled" checked>
                                    <label class="form-check-label" for="sshEnabled">SSH/Telnet</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="httpEnabled" name="http_enabled" checked>
                                    <label class="form-check-label" for="httpEnabled">HTTP/HTTPS</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="wmiEnabled" name="wmi_enabled">
                                    <label class="form-check-label" for="wmiEnabled">WMI (Windows)</label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3" id="snmpSettings">
                                    <label class="form-label">SNMP 설정</label>
                                    <select class="form-select mb-2" id="snmpVersion" name="snmp_version">
                                        <option value="1">SNMPv1</option>
                                        <option value="2c" selected>SNMPv2c</option>
                                        <option value="3">SNMPv3</option>
                                    </select>
                                    <input type="text" class="form-control mb-2" id="snmpCommunity" name="snmp_community" placeholder="Community String (e.g. public)" value="public">
                                    <div id="snmpv3Options" style="display: none;">
                                        <input type="text" class="form-control mb-2" name="snmp_username" placeholder="Username">
                                        <input type="password" class="form-control mb-2" name="snmp_auth_pass" placeholder="Auth Password">
                                        <select class="form-select mb-2" name="snmp_auth_protocol">
                                            <option value="MD5">MD5</option>
                                            <option value="SHA">SHA</option>
                                        </select>
                                        <input type="password" class="form-control mb-2" name="snmp_priv_pass" placeholder="Priv Password">
                                        <select class="form-select mb-2" name="snmp_priv_protocol">
                                            <option value="DES">DES</option>
                                            <option value="AES">AES</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="mb-3" id="sshSettings">
                                    <label class="form-label">SSH/Telnet 설정</label>
                                    <input type="text" class="form-control mb-2" name="ssh_username" placeholder="Username">
                                    <input type="password" class="form-control mb-2" name="ssh_password" placeholder="Password">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="useKeyAuth" name="use_key_auth">
                                        <label class="form-check-label" for="useKeyAuth">키 인증 사용</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">고급 설정</label>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">타임아웃 (초)</span>
                                        <input type="number" class="form-control" name="timeout" value="30" min="5" max="120">
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="deepFingerprinting" name="deep_fingerprinting" checked>
                                        <label class="form-check-label" for="deepFingerprinting">심층 스캔 (더 정확하지만 시간이 오래 걸림)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary" id="startCustomScan">
                                <i class="fas fa-search me-2"></i> 장비 스캔 시작
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        // SNMP 버전 변경 이벤트
        document.getElementById('snmpVersion').addEventListener('change', function() {
            const snmpv3Options = document.getElementById('snmpv3Options');
            if (this.value === '3') {
                snmpv3Options.style.display = 'block';
            } else {
                snmpv3Options.style.display = 'none';
            }
        });
        
        // 스캔 방법 변경 이벤트
        document.getElementById('snmpEnabled').addEventListener('change', function() {
            document.getElementById('snmpSettings').style.display = this.checked ? 'block' : 'none';
        });
        
        document.getElementById('sshEnabled').addEventListener('change', function() {
            document.getElementById('sshSettings').style.display = this.checked ? 'block' : 'none';
        });
        
        // 스캔 시작 버튼 이벤트
        document.getElementById('startCustomScan').addEventListener('click', function() {
            const form = document.getElementById('scanSettingsForm');
            const formData = new FormData(form);
            const scanSettings = {};
            
            // FormData를 객체로 변환
            for (const [key, value] of formData.entries()) {
                if (key.startsWith('snmp_') || key.startsWith('ssh_') || key.startsWith('http_') || key.startsWith('wmi_')) {
                    scanSettings[key] = value;
                } else if (key === 'asset_id') {
                    scanSettings[key] = value;
                } else if (key === 'timeout') {
                    scanSettings[key] = parseInt(value);
                } else if (value === 'on') {
                    scanSettings[key] = true;
                } else {
                    scanSettings[key] = value;
                }
            }
            
            // 스캔 방법 설정
            scanSettings.scan_methods = [];
            if (document.getElementById('snmpEnabled').checked) scanSettings.scan_methods.push('snmp');
            if (document.getElementById('sshEnabled').checked) scanSettings.scan_methods.push('ssh');
            if (document.getElementById('httpEnabled').checked) scanSettings.scan_methods.push('http');
            if (document.getElementById('wmiEnabled').checked) scanSettings.scan_methods.push('wmi');
            
            // 로딩 표시
            detailsBody.innerHTML = `
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    커스텀 설정으로 장비 스캔을 시작합니다...
                </div>
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">사용자 지정 설정으로 장비 스캔 중...</p>
                </div>
            `;
            
            // 커스텀 스캔 요청
            fetch(`/api/scan_device/${scanSettings.asset_id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(scanSettings)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Failed to scan device');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    displayAssetDetails(data.device_info);
                } else {
                    throw new Error(data.error || 'Unknown error during device scan');
                }
            })
            .catch(error => {
                detailsBody.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-times-circle me-2"></i>
                        커스텀 스캔에 실패했습니다: ${error.message}
                    </div>
                    <button class="btn btn-primary" onclick="configureScanSettings(${scanSettings.asset_id})">
                        <i class="fas fa-cog me-2"></i> 스캔 설정 다시 구성
                    </button>
                `;
            });
        });
    }
    
    // 자산 상세 정보 표시 함수
    function displayAssetDetails(asset) {
        const detailsBody = document.getElementById('assetDetailsBody');
        const detailsTitle = document.getElementById('assetDetailsTitle');
        
        detailsTitle.textContent = `Asset Details: ${asset.name}`;
        
        let htmlContent = '';
        
        // 기본 정보
        htmlContent += `
            <div class="alert ${asset.status === 'online' ? 'alert-success' : 'alert-danger'} d-flex align-items-center" role="alert">
                <i class="fas ${asset.status === 'online' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
                <div>
                    This device is currently <strong>${asset.status.toUpperCase()}</strong>
                </div>
            </div>
            
            <div class="mb-3">
                <div class="card bg-dark border-secondary">
                    <div class="card-header">
                        <h6 class="mb-0">Basic Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>IP Address:</strong> ${asset.ip_address}</p>
                                <p><strong>FQDN:</strong> ${asset.name}</p>
                                <p><strong>Device Type:</strong> ${asset.asset_type}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Category:</strong> ${asset.category.charAt(0).toUpperCase() + asset.category.slice(1)}</p>
                                <p><strong>Detection Method:</strong> ${asset.detection_method || 'Standard SNMP'}</p>
                                <p><strong>Last Updated:</strong> ${new Date().toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <ul class="nav nav-tabs mb-3" id="assetTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="hw-tab" data-bs-toggle="tab" data-bs-target="#hw-tab-pane" type="button" role="tab">Hardware</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sw-tab" data-bs-toggle="tab" data-bs-target="#sw-tab-pane" type="button" role="tab">Software</button>
                </li>
            </ul>
            
            <div class="tab-content" id="assetTabContent">
                <!-- Hardware Tab -->
                <div class="tab-pane fade show active" id="hw-tab-pane" role="tabpanel" aria-labelledby="hw-tab" tabindex="0">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-dark border-secondary mb-3">
                                <div class="card-header">Hardware Information</div>
                                <div class="card-body">
                                    <table class="table table-dark table-bordered">
                                        <tr>
                                            <th width="40%">Name (FQDN)</th>
                                            <td>${asset.hardware.name || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Brand/Manufacturer</th>
                                            <td>${asset.hardware.brand || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Model/Type</th>
                                            <td>${asset.hardware.model || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Main Function</th>
                                            <td>${asset.hardware.main_function || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Serial Number</th>
                                            <td>${asset.hardware.serial_number || 'N/A'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-dark border-secondary mb-3">
                                <div class="card-header">System Information</div>
                                <div class="card-body">
                                    <table class="table table-dark table-bordered">
                                        <tr>
                                            <th width="40%">Physical Interfaces</th>
                                            <td>${asset.hardware.physical_interfaces || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>System Software</th>
                                            <td>${asset.hardware.system_software || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Software Version</th>
                                            <td>${asset.hardware.software_version || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Firmware Version</th>
                                            <td>${asset.hardware.firmware_version || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Supported Protocols</th>
                                            <td>${asset.hardware.protocols || 'N/A'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Software Tab -->
                <div class="tab-pane fade" id="sw-tab-pane" role="tabpanel" aria-labelledby="sw-tab" tabindex="0">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-dark border-secondary mb-3">
                                <div class="card-header">Software Information</div>
                                <div class="card-body">
                                    <table class="table table-dark table-bordered">
                                        <tr>
                                            <th width="40%">Installed Hardware</th>
                                            <td>${asset.software.hardware_components || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Brand/Manufacturer</th>
                                            <td>${asset.software.brand || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Model/Type</th>
                                            <td>${asset.software.model || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Main Function</th>
                                            <td>${asset.software.main_function || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Software Version</th>
                                            <td>${asset.software.version || 'N/A'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-dark border-secondary mb-3">
                                <div class="card-header">Software Details</div>
                                <div class="card-body">
                                    <table class="table table-dark table-bordered">
                                        <tr>
                                            <th width="40%">Installation Date</th>
                                            <td>${asset.software.installed_date || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Patch Level</th>
                                            <td>${asset.software.patch_level || 'N/A'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card bg-dark border-secondary mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Device Detection Methods</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">The following methods are used to accurately detect brand and model information:</p>
                    <ol>
                        <li><strong>SNMP OID Querying:</strong> SNMP OIDs like <code>1.3.6.1.2.1.1.1.0</code> (sysDescr) and <code>1.3.6.1.2.1.1.5.0</code> (sysName) are queried to obtain manufacturer and model information.</li>
                        <li><strong>SSH/Telnet Command Execution:</strong> For compatible devices, commands like <code>show version</code> or <code>system info</code> are executed to extract detailed hardware and software information.</li>
                        <li><strong>WMI Queries:</strong> For Windows-based devices, WMI queries extract system manufacturer and model information.</li>
                        <li><strong>LLDP/CDP Information:</strong> Network discovery protocols provide device capabilities and model information.</li>
                        <li><strong>MAC OUI Lookup:</strong> The first 6 digits of MAC addresses are checked against an OUI database to identify manufacturers.</li>
                    </ol>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        For more accurate device information, ensure SNMP is properly configured on network devices with appropriate community strings.
                    </div>
                </div>
            </div>
        `;
        
        detailsBody.innerHTML = htmlContent;
    }
    
    // 기존 자산 스캔 버튼 이벤트
    scanButton.addEventListener('click', function() {
        // 모달 초기화
        scanProgress.classList.remove('d-none');
        scanResults.classList.add('d-none');
        progressBar.style.width = '0%';
        scanStatus.textContent = 'Initializing scan...';
        scanResultsBody.innerHTML = '';
        
        // 모달 표시
        scanModal.show();
        
        // 타임아웃 설정
        let scanTimeout;
        let progressInterval;
        let currentProgress = 0;
        
        // 진행 상태 업데이트 함수
        function updateProgress() {
            if (currentProgress < 90) {
                currentProgress += 1;
                progressBar.style.width = currentProgress + '%';
                
                // 진행 상태에 따른 메시지 업데이트
                if (currentProgress < 20) {
                    scanStatus.textContent = '네트워크 초기화 중...';
                } else if (currentProgress < 50) {
                    scanStatus.textContent = '호스트 검색 중...';
                } else if (currentProgress < 80) {
                    scanStatus.textContent = '장치 정보 수집 중...';
                } else {
                    scanStatus.textContent = '결과 처리 중...';
                }
            }
        }
        
        // 진행 상태 업데이트 시작
        progressInterval = setInterval(updateProgress, 300);
        
        // 스캔 타임아웃 설정 (60초)
        scanTimeout = setTimeout(() => {
            clearInterval(progressInterval);
            scanStatus.textContent = '스캔 시간이 초과되었습니다. 서브넷을 더 작게 설정하거나 다시 시도해주세요.';
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-danger');
            
            // 에러 알림 표시
            scanAlert.classList.remove('d-none', 'alert-success');
            scanAlert.classList.add('alert-danger');
            scanAlert.textContent = '스캔 시간이 초과되었습니다.';
        }, 60000); // 60초 타임아웃
        
        // 현재 네트워크 정보 가져오기
        fetch('/api/get_network_info')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to get network information');
                }
                return response.json();
            })
            .then(data => {
                // 실제 로컬 네트워크 서브넷 설정
                const subnet = data.subnet || "192.168.1.0/24";
                document.getElementById('subnet').value = subnet;
                scanStatus.textContent = `서브넷 ${subnet} 스캔 중...`;
                progressBar.style.width = '10%';
                
                console.log("Starting real network scan on subnet:", subnet);
                
                // 실제 네트워크 스캔 실행
                return fetch('/api/scan_network', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        subnet: subnet,
                        add_all_to_assets: true,
                        scan_methods: ['ping', 'arp', 'snmp', 'mdns', 'nmap'],
                        device_fingerprinting: true
                    })
                });
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Network scan request failed');
                    });
                }
                progressBar.style.width = '80%';
                scanStatus.textContent = '결과 처리 중...';
                return response.json();
            })
            .then(data => {
                // 타임아웃 및 진행 상태 업데이트 중지
                clearTimeout(scanTimeout);
                clearInterval(progressInterval);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // 결과 표시
                scanProgress.classList.add('d-none');
                scanResults.classList.remove('d-none');
                
                // 결과 테이블 채우기
                scanResultsBody.innerHTML = '';
                if (data.results && data.results.length > 0) {
                    data.results.forEach(device => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${device.ip_address}</td>
                            <td>${device.hostname || device.fqdn || 'Unknown'}</td>
                            <td>${device.device_type || 'Unknown'}</td>
                            <td><span class="badge bg-success">Online</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary asset-details" data-asset-id="${device.id}" data-bs-toggle="modal" data-bs-target="#assetDetailsModal">
                                    <i class="fas fa-info-circle me-1"></i> Details
                                </button>
                            </td>
                        `;
                        scanResultsBody.appendChild(row);
                    });
                    
                    // 새로 추가된 Details 버튼에 이벤트 연결
                    document.querySelectorAll('#scanResultsBody .asset-details').forEach(button => {
                        button.addEventListener('click', function() {
                            const assetId = this.dataset.assetId;
                            loadAssetDetails(assetId);
                        });
                    });
                } else {
                    scanResultsBody.innerHTML = '<tr><td colspan="5" class="text-center">발견된 장치가 없습니다.</td></tr>';
                }
                
                // 알림 표시
                scanAlert.classList.remove('d-none', 'alert-danger');
                scanAlert.classList.add('alert-success');
                scanAlert.textContent = `네트워크 스캔 완료. ${data.results ? data.results.length : 0}개 장치 발견 및 자산 목록에 추가됨.`;
                
                // 페이지 새로고침하여 업데이트된 자산 목록 표시 (약간 지연)
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            })
            .catch(error => {
                // 타임아웃 및 진행 상태 업데이트 중지
                clearTimeout(scanTimeout);
                clearInterval(progressInterval);
                
                console.error('Scan error:', error);
                progressBar.style.width = '100%';
                scanStatus.textContent = `오류: ${error.message}`;
                scanProgress.classList.add('d-none');
                scanResults.classList.remove('d-none');
                scanResultsBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">스캔 중 오류가 발생했습니다: ' + error.message + '</td></tr>';
                
                // 에러 알림 표시
                scanAlert.classList.remove('d-none', 'alert-success');
                scanAlert.classList.add('alert-danger');
                scanAlert.textContent = `오류: ${error.message}`;
            });
    });
    
    // 장치 추가 버튼 이벤트 처리
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-device')) {
            const button = e.target;
            const ip = button.dataset.ip;
            const hostname = button.dataset.hostname;
            const deviceType = button.dataset.type;
            
            // 장치 추가 API 호출
            fetch('/api/add_asset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'ip': ip,
                    'name': hostname,
                    'device_type': deviceType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 성공 알림
                    scanAlert.classList.remove('d-none', 'alert-danger');
                    scanAlert.classList.add('alert-success');
                    scanAlert.textContent = `Device ${hostname} (${ip}) added to inventory.`;
                    
                    // 버튼 비활성화
                    button.disabled = true;
                    button.textContent = 'Added';
                } else {
                    throw new Error(data.error || 'Failed to add device');
                }
            })
            .catch(error => {
                scanAlert.classList.remove('d-none', 'alert-success');
                scanAlert.classList.add('alert-danger');
                scanAlert.textContent = `Error: ${error.message}`;
            });
        }
    });
});
</script>
{% endblock %}
